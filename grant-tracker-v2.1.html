<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GRANT RECON | Mission Control v2.1</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;600;700&family=Outfit:wght@300;400;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg: #0a0e14;
            --surface: #151b26;
            --surface-light: #1f2937;
            --border: #2d3748;
            --border-bright: #4a5568;
            --primary: #10b981;
            --primary-dark: #059669;
            --secondary: #3b82f6;
            --hazard: #f59e0b;
            --danger: #ef4444;
            --success: #10b981;
            --text: #f3f4f6;
            --text-muted: #9ca3af;
            --text-dim: #6b7280;
            --purple: #8b5cf6;
            --cyan: #06b6d4;

            --status-discovered: #3b82f6;
            --status-researching: #8b5cf6;
            --status-preparing: #f59e0b;
            --status-submitted: #06b6d4;
            --status-approved: #10b981;
            --status-rejected: #ef4444;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: 'Outfit', sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Atmospheric Background */
        body::before {
            content: "";
            position: fixed;
            inset: 0;
            background:
                radial-gradient(circle at 20% 10%, rgba(16, 185, 129, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(59, 130, 246, 0.06) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(139, 92, 246, 0.04) 0%, transparent 70%);
            pointer-events: none;
            z-index: 0;
        }

        /* Scanline overlay */
        body::after {
            content: "";
            position: fixed;
            inset: 0;
            z-index: 999;
            pointer-events: none;
            background: linear-gradient(rgba(0,0,0,0) 50%, rgba(0,0,0,0.05) 50%);
            background-size: 100% 4px;
            opacity: 0.1;
            animation: scanline 8s linear infinite;
        }

        @keyframes scanline {
            0% { transform: translateY(0); }
            100% { transform: translateY(4px); }
        }

        /* Header */
        .header {
            padding: 20px 32px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(10, 14, 20, 0.95);
            backdrop-filter: blur(10px);
            z-index: 100;
            position: relative;
        }

        .logo {
            font-family: 'IBM Plex Mono';
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--primary);
            letter-spacing: -0.02em;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            background: var(--primary);
            clip-path: polygon(0 0, 100% 0, 85% 100%, 0 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            color: var(--bg);
        }

        .status-badge {
            font-size: 0.7rem;
            padding: 4px 10px;
            border: 1px solid var(--primary);
            color: var(--primary);
            border-radius: 3px;
            letter-spacing: 0.08em;
            font-family: 'IBM Plex Mono';
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .nav-tabs {
            display: flex;
            gap: 4px;
            background: var(--surface);
            padding: 4px;
            border-radius: 6px;
        }

        .nav-tab {
            padding: 8px 20px;
            font-size: 0.85rem;
            font-weight: 600;
            font-family: 'IBM Plex Mono';
            cursor: pointer;
            border: none;
            background: transparent;
            color: var(--text-muted);
            border-radius: 4px;
            transition: all 0.2s;
            letter-spacing: 0.02em;
        }

        .nav-tab.active {
            background: var(--primary);
            color: var(--bg);
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }

        .nav-tab:hover:not(.active) {
            background: var(--surface-light);
            color: var(--text);
        }

        /* Main Layout */
        .main-layout {
            display: flex;
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        /* Sidebar */
        .sidebar {
            width: 380px;
            padding: 32px 24px;
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 24px;
            background: var(--surface);
            overflow-y: auto;
            position: relative;
        }

        .sidebar-section {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .section-title {
            font-family: 'IBM Plex Mono';
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        label {
            font-family: 'IBM Plex Mono';
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        input, select, textarea {
            background: var(--bg);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 12px 14px;
            font-family: 'Outfit';
            font-size: 0.9rem;
            outline: none;
            transition: all 0.2s;
            border-radius: 6px;
        }

        input:focus, select:focus, textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 80px;
            font-family: 'IBM Plex Mono';
            font-size: 0.85rem;
        }

        .filter-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .chip {
            padding: 6px 12px;
            font-size: 0.8rem;
            border: 1px solid var(--border);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'IBM Plex Mono';
            background: var(--bg);
            color: var(--text-muted);
        }

        .chip:hover {
            border-color: var(--border-bright);
            background: var(--surface-light);
        }

        .chip.active {
            background: var(--primary);
            border-color: var(--primary);
            color: var(--bg);
            font-weight: 600;
        }

        .btn-scan {
            background: var(--primary);
            color: var(--bg);
            font-weight: 700;
            border: none;
            padding: 16px;
            cursor: pointer;
            font-family: 'IBM Plex Mono';
            text-transform: uppercase;
            transition: all 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            letter-spacing: 0.05em;
            border-radius: 6px;
            font-size: 0.85rem;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
        }

        .btn-scan:hover {
            background: var(--primary-dark);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.3);
            transform: translateY(-1px);
        }

        .btn-scan:active {
            transform: translateY(0);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .stat-card {
            background: var(--bg);
            border: 1px solid var(--border);
            padding: 16px;
            border-radius: 6px;
        }

        .stat-label {
            font-size: 0.7rem;
            color: var(--text-dim);
            text-transform: uppercase;
            font-family: 'IBM Plex Mono';
            letter-spacing: 0.05em;
            margin-bottom: 6px;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary);
            font-family: 'IBM Plex Mono';
        }

        /* Main Content Area */
        .content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .console-feed {
            height: 160px;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            font-family: 'IBM Plex Mono';
            font-size: 0.8rem;
            color: var(--text-muted);
            overflow-y: auto;
            background: rgba(0,0,0,0.2);
        }

        .log-entry {
            margin-bottom: 6px;
            display: flex;
            gap: 12px;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-4px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .log-time {
            color: var(--cyan);
            opacity: 0.7;
            min-width: 80px;
        }

        .log-text { color: var(--text); }
        .log-success { color: var(--success); }
        .log-warn { color: var(--hazard); }
        .log-error { color: var(--danger); }

        /* Results Container */
        .results-container {
            flex: 1;
            padding: 32px;
            overflow-y: auto;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 28px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }

        .results-title {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .results-subtitle {
            font-family: 'IBM Plex Mono';
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .results-meta {
            display: flex;
            gap: 24px;
            align-items: center;
        }

        .meta-item {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .meta-label {
            font-size: 0.7rem;
            color: var(--text-dim);
            font-family: 'IBM Plex Mono';
            text-transform: uppercase;
        }

        .meta-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary);
            font-family: 'IBM Plex Mono';
        }

        .view-controls {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }

        .view-btn {
            padding: 8px 16px;
            font-size: 0.8rem;
            border: 1px solid var(--border);
            background: var(--surface);
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'IBM Plex Mono';
            border-radius: 4px;
        }

        .view-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: var(--bg);
        }

        .view-btn:hover:not(.active) {
            border-color: var(--border-bright);
            background: var(--surface-light);
        }

        /* Grid Layout */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: 24px;
        }

        /* Grant Card */
        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            padding: 24px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            display: flex;
            flex-direction: column;
            border-radius: 8px;
            overflow: hidden;
        }

        .card::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary);
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.3s ease;
        }

        .card:hover::before {
            transform: scaleX(1);
        }

        .card:hover {
            border-color: var(--border-bright);
            transform: translateY(-4px);
            box-shadow: 0 12px 32px rgba(0,0,0,0.4);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
            gap: 12px;
        }

        .card-badges {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .card-badge {
            font-size: 0.65rem;
            padding: 4px 8px;
            border-radius: 3px;
            font-family: 'IBM Plex Mono';
            letter-spacing: 0.05em;
            font-weight: 600;
        }

        .badge-fed {
            background: rgba(59, 130, 246, 0.15);
            border: 1px solid var(--secondary);
            color: var(--secondary);
        }

        .badge-prov {
            background: rgba(245, 158, 11, 0.15);
            border: 1px solid var(--hazard);
            color: var(--hazard);
        }

        .badge-corp {
            background: rgba(139, 92, 246, 0.15);
            border: 1px solid var(--purple);
            color: var(--purple);
        }

        .deadline-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            font-family: 'IBM Plex Mono';
            padding: 4px 10px;
            border-radius: 4px;
            font-weight: 600;
        }

        .deadline-urgent {
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid var(--danger);
            color: var(--danger);
            animation: urgentPulse 2s ease-in-out infinite;
        }

        @keyframes urgentPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .deadline-soon {
            background: rgba(245, 158, 11, 0.15);
            border: 1px solid var(--hazard);
            color: var(--hazard);
        }

        .deadline-ok {
            background: rgba(16, 185, 129, 0.15);
            border: 1px solid var(--success);
            color: var(--success);
        }

        .deadline-rolling {
            background: rgba(107, 114, 128, 0.15);
            border: 1px solid var(--text-dim);
            color: var(--text-muted);
        }

        .card-agency {
            font-size: 0.7rem;
            color: var(--text-dim);
            margin-bottom: 8px;
            font-family: 'IBM Plex Mono';
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .card-title {
            font-size: 1.15rem;
            font-weight: 700;
            margin-bottom: 12px;
            line-height: 1.3;
            color: var(--text);
        }

        .card-desc {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-bottom: 16px;
            flex-grow: 1;
            line-height: 1.5;
        }

        .card-tags {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }

        .tag {
            font-size: 0.65rem;
            padding: 3px 8px;
            background: rgba(255,255,255,0.05);
            color: var(--text-muted);
            border-radius: 3px;
            font-family: 'IBM Plex Mono';
        }

        .status-selector {
            margin-bottom: 16px;
            padding: 12px;
            background: rgba(0,0,0,0.3);
            border-radius: 6px;
        }

        .status-label {
            font-size: 0.7rem;
            color: var(--text-dim);
            margin-bottom: 8px;
            font-family: 'IBM Plex Mono';
            text-transform: uppercase;
        }

        .status-options {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .status-option {
            padding: 4px 10px;
            font-size: 0.7rem;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'IBM Plex Mono';
            border: 1px solid transparent;
        }

        .status-option:hover {
            transform: scale(1.05);
        }

        .status-discovered { background: rgba(59, 130, 246, 0.2); color: var(--status-discovered); border-color: var(--status-discovered); }
        .status-researching { background: rgba(139, 92, 246, 0.2); color: var(--status-researching); border-color: var(--status-researching); }
        .status-preparing { background: rgba(245, 158, 11, 0.2); color: var(--status-preparing); border-color: var(--status-preparing); }
        .status-submitted { background: rgba(6, 182, 212, 0.2); color: var(--status-submitted); border-color: var(--status-submitted); }
        .status-approved { background: rgba(16, 185, 129, 0.2); color: var(--status-approved); border-color: var(--status-approved); }
        .status-rejected { background: rgba(239, 68, 68, 0.2); color: var(--status-rejected); border-color: var(--status-rejected); }

        .status-option.active {
            font-weight: 700;
            box-shadow: 0 0 0 2px currentColor;
        }

        .card-footer {
            padding-top: 16px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }

        .amount {
            font-family: 'IBM Plex Mono';
            font-weight: 700;
            color: var(--primary);
            font-size: 0.95rem;
        }

        .card-actions {
            display: flex;
            gap: 8px;
        }

        .btn-action {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
            padding: 6px 14px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'IBM Plex Mono';
            border-radius: 4px;
        }

        .btn-action:hover {
            border-color: var(--primary);
            background: rgba(16, 185, 129, 0.1);
            color: var(--primary);
        }

        .btn-track {
            background: var(--primary);
            border-color: var(--primary);
            color: var(--bg);
            font-weight: 600;
        }

        .btn-track:hover {
            background: var(--primary-dark);
        }

        .btn-track.tracked {
            background: rgba(16, 185, 129, 0.2);
            border-color: var(--primary);
            color: var(--primary);
        }

        /* Notes Section */
        .card-notes {
            margin-top: 12px;
            padding: 12px;
            background: rgba(0,0,0,0.3);
            border-radius: 6px;
            border: 1px solid var(--border);
        }

        .notes-textarea {
            width: 100%;
            min-height: 60px;
            background: transparent;
            border: none;
            color: var(--text);
            font-size: 0.85rem;
            resize: vertical;
            padding: 0;
        }

        .notes-textarea::placeholder {
            color: var(--text-dim);
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--border-bright); }

        .hidden { display: none !important; }

        /* Export Modal */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 20px;
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .btn-modal {
            flex: 1;
            padding: 12px;
            font-family: 'IBM Plex Mono';
            font-size: 0.85rem;
            font-weight: 600;
            border: 1px solid var(--border);
            background: var(--bg);
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 6px;
        }

        .btn-modal:hover {
            border-color: var(--primary);
            background: rgba(16, 185, 129, 0.1);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: var(--text-muted);
        }

        .empty-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .empty-desc {
            font-size: 0.95rem;
        }

        /* Organization Profile Section */
        .profile-section {
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg);
            overflow: hidden;
        }

        .profile-toggle {
            width: 100%;
            padding: 12px 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: transparent;
            border: none;
            color: var(--primary);
            font-family: 'IBM Plex Mono';
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            cursor: pointer;
            transition: background 0.2s;
        }

        .profile-toggle:hover {
            background: var(--surface-light);
        }

        .profile-toggle-arrow {
            transition: transform 0.2s;
            font-size: 0.65rem;
        }

        .profile-toggle-arrow.open {
            transform: rotate(180deg);
        }

        .profile-body {
            display: none;
            padding: 14px;
            border-top: 1px solid var(--border);
            flex-direction: column;
            gap: 14px;
        }

        .profile-body.open {
            display: flex;
        }

        .profile-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .profile-tag {
            padding: 5px 10px;
            font-size: 0.7rem;
            border: 1px solid var(--border);
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'IBM Plex Mono';
            background: transparent;
            color: var(--text-muted);
        }

        .profile-tag:hover {
            border-color: var(--border-bright);
        }

        .profile-tag.selected {
            background: var(--primary);
            border-color: var(--primary);
            color: var(--bg);
            font-weight: 600;
        }

        .province-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
        }

        .province-check {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            font-family: 'IBM Plex Mono';
            color: var(--text-muted);
            cursor: pointer;
        }

        .province-check input[type="checkbox"] {
            width: 14px;
            height: 14px;
            padding: 0;
            accent-color: var(--primary);
        }

        .btn-save-profile {
            background: var(--secondary);
            color: white;
            font-weight: 700;
            border: none;
            padding: 12px;
            cursor: pointer;
            font-family: 'IBM Plex Mono';
            text-transform: uppercase;
            transition: all 0.2s;
            border-radius: 6px;
            font-size: 0.8rem;
            letter-spacing: 0.05em;
        }

        .btn-save-profile:hover {
            filter: brightness(1.15);
            transform: translateY(-1px);
        }

        /* Relevance Badge */
        .relevance-badge {
            font-size: 0.7rem;
            padding: 4px 10px;
            border-radius: 4px;
            font-family: 'IBM Plex Mono';
            font-weight: 700;
            letter-spacing: 0.03em;
            white-space: nowrap;
        }

        .relevance-high {
            background: rgba(16, 185, 129, 0.15);
            border: 1px solid var(--success);
            color: var(--success);
        }

        .relevance-mid {
            background: rgba(245, 158, 11, 0.15);
            border: 1px solid var(--hazard);
            color: var(--hazard);
        }

        .relevance-low {
            background: rgba(107, 114, 128, 0.15);
            border: 1px solid var(--text-dim);
            color: var(--text-dim);
        }

        .badge-recommended {
            background: rgba(59, 130, 246, 0.15);
            border: 1px solid var(--secondary);
            color: var(--secondary);
            font-size: 0.65rem;
            padding: 3px 8px;
            border-radius: 3px;
            font-family: 'IBM Plex Mono';
            font-weight: 700;
            letter-spacing: 0.05em;
        }

        /* AI Intelligence Summary */
        .ai-summary {
            background: var(--bg);
            border: 1px solid var(--secondary);
            border-radius: 6px;
            padding: 14px;
        }

        .ai-summary-title {
            font-family: 'IBM Plex Mono';
            font-size: 0.7rem;
            color: var(--secondary);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .ai-stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
        }

        .ai-stat {
            text-align: center;
        }

        .ai-stat-value {
            font-family: 'IBM Plex Mono';
            font-weight: 700;
            font-size: 1.2rem;
            color: var(--secondary);
        }

        .ai-stat-label {
            font-size: 0.6rem;
            color: var(--text-dim);
            text-transform: uppercase;
            font-family: 'IBM Plex Mono';
            letter-spacing: 0.03em;
        }

        /* Relevance Filter Chips */
        .relevance-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 10px;
        }

        .relevance-chip {
            padding: 4px 10px;
            font-size: 0.7rem;
            border: 1px solid var(--border);
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'IBM Plex Mono';
            background: transparent;
            color: var(--text-muted);
        }

        .relevance-chip:hover {
            border-color: var(--border-bright);
        }

        .relevance-chip.active {
            background: var(--secondary);
            border-color: var(--secondary);
            color: white;
            font-weight: 600;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .grid {
                grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            }
        }

        @media (max-width: 900px) {
            .sidebar {
                width: 320px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .header {
                padding: 16px 20px;
                flex-direction: column;
                gap: 12px;
                align-items: flex-start;
            }

            .nav-tabs {
                width: 100%;
                justify-content: stretch;
            }

            .nav-tab {
                flex: 1;
                text-align: center;
                padding: 10px 12px;
                font-size: 0.75rem;
            }

            .main-layout {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid var(--border);
                max-height: none;
                padding: 20px 16px;
            }

            .console-feed {
                height: 120px;
                padding: 16px;
                font-size: 0.75rem;
            }

            .results-container {
                padding: 20px 16px;
            }

            .results-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 16px;
            }

            .results-meta {
                width: 100%;
            }

            .grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .card {
                padding: 20px;
            }

            .card-title {
                font-size: 1.05rem;
            }

            .card-footer {
                flex-direction: column;
                gap: 12px;
                align-items: stretch;
            }

            .card-actions {
                width: 100%;
                justify-content: stretch;
            }

            .btn-action {
                flex: 1;
            }
        }
    </style>
</head>
<body>

    <header class="header">
        <div class="logo">
            <div class="logo-icon">â—†</div>
            <span>GRANT_RECON</span>
            <span style="color: var(--text-dim); font-weight: 400; font-size: 0.9rem;">v2.1</span>
            <span class="status-badge">OPERATIONAL</span>
        </div>

        <nav class="nav-tabs">
            <button class="nav-tab active" data-view="discover">DISCOVER</button>
            <button class="nav-tab" data-view="tracked">MY GRANTS (<span id="trackedCount">0</span>)</button>
        </nav>
    </header>

    <div class="main-layout">

        <!-- SIDEBAR CONTROLS -->
        <aside class="sidebar">

            <!-- ORGANIZATION PROFILE -->
            <div class="profile-section">
                <button class="profile-toggle" onclick="toggleProfile()">
                    <span>Organization Profile</span>
                    <span class="profile-toggle-arrow" id="profileArrow">â–¼</span>
                </button>
                <div class="profile-body" id="profileBody">
                    <div class="input-group">
                        <label>Mission Statement</label>
                        <textarea id="orgMission" placeholder="Describe your organization's mission, the populations you serve, and your core programs..."></textarea>
                    </div>

                    <div class="input-group">
                        <label>Program Areas</label>
                        <div class="profile-tags" id="programAreaTags">
                            <span class="profile-tag" data-area="PTSD Treatment">PTSD Treatment</span>
                            <span class="profile-tag" data-area="Peer Support">Peer Support</span>
                            <span class="profile-tag" data-area="Family Services">Family Services</span>
                            <span class="profile-tag" data-area="Transition to Civilian Life">Transition</span>
                            <span class="profile-tag" data-area="Research">Research</span>
                            <span class="profile-tag" data-area="Family Support">Family Support</span>
                            <span class="profile-tag" data-area="Mental Health">Mental Health</span>
                            <span class="profile-tag" data-area="Physical Rehabilitation">Phys. Rehab</span>
                            <span class="profile-tag" data-area="Homelessness">Homelessness</span>
                            <span class="profile-tag" data-area="Employment">Employment</span>
                            <span class="profile-tag" data-area="Education">Education</span>
                            <span class="profile-tag" data-area="Addiction Recovery">Addiction Recovery</span>
                        </div>
                    </div>

                    <div class="input-group">
                        <label>Organization Type</label>
                        <select id="orgType">
                            <option value="">Select...</option>
                            <option value="Registered Charity">Registered Charity</option>
                            <option value="Non-Profit">Non-Profit</option>
                            <option value="Research Institution">Research Institution</option>
                            <option value="Government Agency">Government Agency</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>

                    <div class="input-group">
                        <label>Annual Budget Range</label>
                        <select id="orgBudget">
                            <option value="">Select...</option>
                            <option value="500000">Under $500K</option>
                            <option value="1000000">$500K - $1M</option>
                            <option value="5000000">$1M - $5M</option>
                            <option value="25000000">$5M - $25M</option>
                            <option value="50000000">Over $25M</option>
                        </select>
                    </div>

                    <div class="input-group">
                        <label>Provinces Active In</label>
                        <div class="province-grid" id="provinceGrid">
                            <label class="province-check"><input type="checkbox" value="ON"> Ontario</label>
                            <label class="province-check"><input type="checkbox" value="BC"> British Columbia</label>
                            <label class="province-check"><input type="checkbox" value="AB"> Alberta</label>
                            <label class="province-check"><input type="checkbox" value="QC"> Quebec</label>
                            <label class="province-check"><input type="checkbox" value="NS"> Nova Scotia</label>
                            <label class="province-check"><input type="checkbox" value="MB"> Manitoba</label>
                            <label class="province-check"><input type="checkbox" value="SK"> Saskatchewan</label>
                            <label class="province-check"><input type="checkbox" value="NB"> New Brunswick</label>
                            <label class="province-check"><input type="checkbox" value="NL"> Newfoundland</label>
                            <label class="province-check"><input type="checkbox" value="PE"> PEI</label>
                            <label class="province-check"><input type="checkbox" value="NT"> NWT</label>
                            <label class="province-check"><input type="checkbox" value="YT"> Yukon</label>
                            <label class="province-check"><input type="checkbox" value="NU"> Nunavut</label>
                        </div>
                    </div>

                    <button class="btn-save-profile" onclick="saveOrgProfile()">Save Profile</button>
                </div>
            </div>

            <!-- AI INTELLIGENCE SUMMARY (hidden until profile exists) -->
            <div class="ai-summary hidden" id="aiSummary">
                <div class="ai-summary-title">â—ˆ AI Relevance Scoring</div>
                <div class="ai-stats-grid">
                    <div class="ai-stat">
                        <div class="ai-stat-value" id="aiScored">0</div>
                        <div class="ai-stat-label">Scored</div>
                    </div>
                    <div class="ai-stat">
                        <div class="ai-stat-value" id="aiAvgScore">--</div>
                        <div class="ai-stat-label">Avg Match</div>
                    </div>
                    <div class="ai-stat">
                        <div class="ai-stat-value" id="aiHighConf">0</div>
                        <div class="ai-stat-label">&gt;80%</div>
                    </div>
                </div>
                <div class="relevance-filters" id="relevanceFilters">
                    <div class="relevance-chip active" data-min="0">All</div>
                    <div class="relevance-chip" data-min="50">&gt;50%</div>
                    <div class="relevance-chip" data-min="70">&gt;70%</div>
                    <div class="relevance-chip" data-min="90">&gt;90%</div>
                </div>
            </div>

            <div class="sidebar-section">
                <div class="section-title">Mission Parameters</div>

                <div class="input-group">
                    <label>Target Keywords</label>
                    <input type="text" id="keywords" value="PTSD, Mental Health, Veterans" placeholder="Keywords...">
                </div>

                <div class="input-group">
                    <label>Jurisdiction Scope</label>
                    <select id="scope">
                        <option value="ALL">All Sources (Federal + Provincial)</option>
                        <option value="FED">Federal Only</option>
                        <option value="ON">Ontario</option>
                        <option value="BC">British Columbia</option>
                        <option value="AB">Alberta</option>
                        <option value="QC">Quebec</option>
                        <option value="NS">Nova Scotia</option>
                    </select>
                </div>

                <div class="input-group">
                    <label>Status Filter</label>
                    <div class="filter-chips" id="statusFilters">
                        <div class="chip active" data-status="all">All</div>
                        <div class="chip" data-status="discovered">Discovered</div>
                        <div class="chip" data-status="researching">Researching</div>
                        <div class="chip" data-status="preparing">Preparing</div>
                        <div class="chip" data-status="submitted">Submitted</div>
                    </div>
                </div>
            </div>

            <button class="btn-scan" onclick="runMission()">
                <span>âš¡</span> INITIATE SCAN
            </button>

            <div class="sidebar-section">
                <div class="section-title">Intelligence Summary</div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Database</div>
                        <div class="stat-value" id="dbCount">50</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Tracked</div>
                        <div class="stat-value" id="trackedStat">0</div>
                    </div>
                </div>
            </div>

            <div style="margin-top: auto;">
                <button class="btn-action" onclick="exportData()" style="width: 100%; padding: 12px; margin-bottom: 12px;">
                    ðŸ“Š EXPORT DATA
                </button>
                <div style="padding: 16px; border: 1px solid var(--border); background: rgba(0,0,0,0.2); border-radius: 6px;">
                    <div style="font-size: 0.7rem; font-family: 'IBM Plex Mono'; color: var(--primary); margin-bottom: 6px;">
                        /// MISSION READY
                    </div>
                    <p style="font-size: 0.8rem; color: var(--text-muted); line-height: 1.4;">
                        Tracking <strong>60+</strong> verified funding streams for PTSD & veteran support across Canada.
                    </p>
                </div>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="content-area">

            <!-- CONSOLE LOG -->
            <div class="console-feed" id="console">
                <div class="log-entry">
                    <span class="log-time">[INIT]</span>
                    <span class="log-success">Grant Recon Engine v2.1 initialized successfully.</span>
                </div>
                <div class="log-entry">
                    <span class="log-time">[DATABASE]</span>
                    <span class="log-text">Loaded 50 grant vectors. Ready for deployment.</span>
                </div>
                <div class="log-entry">
                    <span class="log-time">[STORAGE]</span>
                    <span class="log-success">Local persistence enabled. Your data is safe.</span>
                </div>
            </div>

            <!-- RESULTS AREA -->
            <div class="results-container">
                <div class="results-header">
                    <div>
                        <h2 class="results-title" id="viewTitle">Intelligence Report</h2>
                        <span class="results-subtitle">High-Probability Funding Sources</span>
                    </div>
                    <div class="results-meta">
                        <div class="meta-item">
                            <span class="meta-label">Matches</span>
                            <span class="meta-value" id="matchCount">0</span>
                        </div>
                    </div>
                </div>

                <div id="grid" class="grid">
                    <!-- CARDS INJECTED HERE -->
                </div>

                <div id="emptyState" class="empty-state hidden">
                    <div class="empty-icon">ðŸŽ¯</div>
                    <div class="empty-title">No grants tracked yet</div>
                    <div class="empty-desc">Use the DISCOVER tab to find grants and track them here.</div>
                </div>
            </div>
        </main>
    </div>

    <!-- EXPORT MODAL -->
    <div id="exportModal" class="modal hidden">
        <div class="modal-content">
            <h3 class="modal-title">Export Grant Data</h3>
            <p style="color: var(--text-muted); margin-bottom: 20px;">Choose your export format:</p>
            <div class="modal-buttons">
                <button class="btn-modal" onclick="downloadJSON()">ðŸ“„ JSON</button>
                <button class="btn-modal" onclick="downloadCSV()">ðŸ“Š CSV</button>
                <button class="btn-modal" onclick="downloadCalendar()">ðŸ“… Calendar</button>
            </div>
            <div class="modal-buttons">
                <button class="btn-modal" onclick="closeExportModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // EXPANDED GRANT DATABASE (50+ Sources)
        // ============================================
        const GRANT_DB = [
            // FEDERAL SOURCES
            {
                id: "VAC-001",
                agency: "VETERANS AFFAIRS CANADA",
                title: "Veteran and Family Well-being Fund",
                desc: "Grants for non-profits conducting research or initiatives supporting well-being. Key priority: Mental Health, Homelessness, and Transition.",
                tags: ["PTSD", "MENTAL HEALTH", "FEDERAL", "VAC"],
                amount: "$100k - $500k",
                scope: "FED",
                type: "fed",
                deadline: "rolling",
                link: "https://www.veterans.gc.ca/en/about-vac/research/veteran-and-family-well-being-fund",
                contact: "veteraninnovation@veterans.gc.ca"
            },
            {
                id: "VAC-008",
                agency: "VETERANS AFFAIRS CANADA",
                title: "Commemorative Partnership Program",
                desc: "Funding for projects designed to honour the contributions and sacrifice of those who have served.",
                tags: ["FEDERAL", "EVENTS", "VETERANS"],
                amount: "Up to $25,000",
                scope: "FED",
                type: "fed",
                deadline: "rolling",
                link: "https://www.veterans.gc.ca/en/remembrance/commemorative-partnership-program",
                contact: "vac.info@veterans.gc.ca"
            },
            {
                id: "CIHR-001",
                agency: "CANADIAN INSTITUTES OF HEALTH RESEARCH",
                title: "Operating Grant: Mental Health",
                desc: "Research funding for mental health innovations, PTSD treatment methodologies, and veteran health outcomes.",
                tags: ["RESEARCH", "MENTAL HEALTH", "FEDERAL"],
                amount: "$50k - $250k",
                scope: "FED",
                type: "fed",
                deadline: "2025-04-20",
                link: "https://cihr-irsc.gc.ca/",
                contact: "support@cihr-irsc.gc.ca"
            },
            {
                id: "ESDC-001",
                agency: "EMPLOYMENT & SOCIAL DEVELOPMENT CANADA",
                title: "Social Development Partnerships Program",
                desc: "Funding for projects addressing homelessness, disability inclusion, and community capacity building.",
                tags: ["FEDERAL", "SOCIAL SERVICES", "CAPACITY"],
                amount: "$50k - $1M",
                scope: "FED",
                type: "fed",
                deadline: "2025-02-28",
                link: "https://www.canada.ca/en/employment-social-development.html",
                contact: "esdc.info@canada.ca"
            },
            {
                id: "PHAC-001",
                agency: "PUBLIC HEALTH AGENCY OF CANADA",
                title: "Mental Health Promotion Innovation Fund",
                desc: "Support for community programs promoting mental wellness and suicide prevention.",
                tags: ["MENTAL HEALTH", "FEDERAL", "PREVENTION"],
                amount: "Up to $100k",
                scope: "FED",
                type: "fed",
                deadline: "2025-05-10",
                link: "https://www.canada.ca/en/public-health.html",
                contact: "phac.info@canada.ca"
            },

            // CORPORATE/FOUNDATION
            {
                id: "BELL-002",
                agency: "BELL LET'S TALK",
                title: "Community Fund 2025",
                desc: "Grants for registered charities to improve access to mental health care, supports, and services.",
                tags: ["MENTAL HEALTH", "CORPORATE", "CHARITY"],
                amount: "Up to $25,000",
                scope: "ALL",
                type: "corp",
                deadline: "rolling",
                link: "https://letstalk.bell.ca/en/",
                contact: "letstalk@bell.ca"
            },
            {
                id: "RBC-001",
                agency: "RBC FOUNDATION",
                title: "Mental Health & Wellness Grants",
                desc: "Supporting organizations that reduce barriers to mental health services for youth and marginalized communities.",
                tags: ["MENTAL HEALTH", "YOUTH", "CORPORATE"],
                amount: "$25k - $100k",
                scope: "ALL",
                type: "corp",
                deadline: "rolling",
                link: "https://www.rbc.com/community-social-impact/",
                contact: "rbc.foundation@rbc.com"
            },
            {
                id: "TD-001",
                agency: "TD BANK GROUP",
                title: "Community Giving Program",
                desc: "Grants for health, education, and financial literacy programs. Supports veteran transition initiatives.",
                tags: ["CORPORATE", "HEALTH", "VETERANS"],
                amount: "$10k - $50k",
                scope: "ALL",
                type: "corp",
                deadline: "rolling",
                link: "https://www.td.com/ca/en/about-td/ready-commitment/",
                contact: "tdcommunity@td.com"
            },
            {
                id: "SCOTIA-001",
                agency: "SCOTIABANK",
                title: "Scotiabank Community Grants",
                desc: "Supporting health and wellness programs in underserved communities.",
                tags: ["CORPORATE", "HEALTH", "COMMUNITY"],
                amount: "Up to $25k",
                scope: "ALL",
                type: "corp",
                deadline: "2025-06-30",
                link: "https://www.scotiabank.com/ca/en/about/community.html",
                contact: "community@scotiabank.com"
            },
            {
                id: "GOOGLE-001",
                agency: "GOOGLE.ORG CANADA",
                title: "Impact Challenge",
                desc: "Grants for organizations using technology to solve social problems including mental health access.",
                tags: ["TECH", "INNOVATION", "CORPORATE"],
                amount: "$50k - $500k",
                scope: "ALL",
                type: "corp",
                deadline: "2025-03-01",
                link: "https://www.google.org/",
                contact: "impactchallenge@google.org"
            },

            // MILITARY/VETERAN-SPECIFIC CHARITIES
            {
                id: "LEGION-005",
                agency: "LEGION NATIONAL FOUNDATION",
                title: "Veteran Support Grants",
                desc: "Funding for initiatives that support Veterans, CAF members, and their families.",
                tags: ["VETERANS", "CHARITY", "NATIONAL"],
                amount: "Variable",
                scope: "FED",
                type: "corp",
                deadline: "rolling",
                link: "https://lnfcanada.ca/",
                contact: "info@lnfcanada.ca"
            },
            {
                id: "TRUE-009",
                agency: "TRUE PATRIOT LOVE",
                title: "Creative & Community Fund",
                desc: "Disbursements for community programs supporting physical/mental health of military members.",
                tags: ["CHARITY", "MENTAL HEALTH", "VETERANS"],
                amount: "$5k - $50k",
                scope: "ALL",
                type: "corp",
                deadline: "2025-04-15",
                link: "https://truepatriotlove.com/",
                contact: "grants@truepatriotlove.com"
            },
            {
                id: "WW-001",
                agency: "WOUNDED WARRIORS CANADA",
                title: "Research & Innovation Grants",
                desc: "Supporting innovative approaches to PTSD treatment and veteran mental health.",
                tags: ["PTSD", "RESEARCH", "VETERANS"],
                amount: "$10k - $100k",
                scope: "ALL",
                type: "corp",
                deadline: "2025-05-30",
                link: "https://woundedwarriors.ca/",
                contact: "info@woundedwarriors.ca"
            },
            {
                id: "VETS-001",
                agency: "VETS CANADA",
                title: "Veteran Homelessness Prevention Fund",
                desc: "Grants to prevent and address homelessness among Canadian veterans.",
                tags: ["VETERANS", "HOMELESSNESS", "SUPPORT"],
                amount: "$5k - $25k",
                scope: "ALL",
                type: "corp",
                deadline: "rolling",
                link: "https://vetscanada.org/",
                contact: "info@vetscanada.org"
            },

            // ONTARIO SOURCES
            {
                id: "OTF-003",
                agency: "ONTARIO TRILLIUM FOUNDATION",
                title: "Resilient Communities Fund",
                desc: "Supports non-profits in Ontario recovering from COVID-19 impacts. Funds eligible for capacity building and mental health program expansion.",
                tags: ["ONTARIO", "CAPACITY", "MENTAL HEALTH"],
                amount: "$10k - $100k",
                scope: "ON",
                type: "prov",
                deadline: "2025-02-15",
                link: "https://otf.ca/our-grants/resilient-communities-fund",
                contact: "otf@otf.ca"
            },
            {
                id: "ON-010",
                agency: "GOV OF ONTARIO",
                title: "Mental Health & Addictions Fund",
                desc: "Targeted provincial funding for community-based mental health services and addiction recovery programs.",
                tags: ["ONTARIO", "HEALTH", "ADDICTIONS"],
                amount: "Variable",
                scope: "ON",
                type: "prov",
                deadline: "2025-03-30",
                link: "https://www.ontario.ca/",
                contact: "moh@ontario.ca"
            },
            {
                id: "OTF-004",
                agency: "ONTARIO TRILLIUM FOUNDATION",
                title: "Grow Grants",
                desc: "Multi-year funding for established organizations looking to expand successful programs.",
                tags: ["ONTARIO", "EXPANSION", "MULTI-YEAR"],
                amount: "$100k - $500k",
                scope: "ON",
                type: "prov",
                deadline: "2025-04-01",
                link: "https://otf.ca/",
                contact: "otf@otf.ca"
            },
            {
                id: "UWGT-001",
                agency: "UNITED WAY GREATER TORONTO",
                title: "Community Impact Grants",
                desc: "Supporting poverty reduction and community health initiatives in the GTA.",
                tags: ["ONTARIO", "TORONTO", "COMMUNITY"],
                amount: "$25k - $200k",
                scope: "ON",
                type: "corp",
                deadline: "2025-02-28",
                link: "https://www.unitedwaygt.org/",
                contact: "grants@uwgt.org"
            },

            // BRITISH COLUMBIA SOURCES
            {
                id: "BC-004",
                agency: "GOVERNMENT OF BC",
                title: "Community Gaming Grants",
                desc: "Human and Social Services stream. Supports programs improving safety, quality of life, and mental health.",
                tags: ["BC", "PROVINCIAL", "SERVICE"],
                amount: "$125k - $250k",
                scope: "BC",
                type: "prov",
                deadline: "rolling",
                link: "https://www2.gov.bc.ca/gov/content/sports-culture/gambling-fundraising/gaming-grants",
                contact: "gaming.grants@gov.bc.ca"
            },
            {
                id: "VFDN-001",
                agency: "VANCOUVER FOUNDATION",
                title: "Disability Inclusion & Accessibility",
                desc: "Grants for programs supporting people with disabilities, including PTSD and mental health conditions.",
                tags: ["BC", "DISABILITY", "MENTAL HEALTH"],
                amount: "$10k - $75k",
                scope: "BC",
                type: "corp",
                deadline: "2025-03-15",
                link: "https://www.vancouverfoundation.ca/",
                contact: "info@vancouverfoundation.ca"
            },
            {
                id: "BC-HEALTH-001",
                agency: "BC MINISTRY OF HEALTH",
                title: "Mental Health & Substance Use Grants",
                desc: "Provincial funding for integrated mental health and addiction services.",
                tags: ["BC", "MENTAL HEALTH", "ADDICTIONS"],
                amount: "$50k - $500k",
                scope: "BC",
                type: "prov",
                deadline: "2025-04-30",
                link: "https://www2.gov.bc.ca/gov/content/health",
                contact: "hlth.grants@gov.bc.ca"
            },

            // ALBERTA SOURCES
            {
                id: "AB-007",
                agency: "GOV OF ALBERTA",
                title: "Community Initiatives Program (CIP)",
                desc: "Project-based funding for initiatives that enhance community well-being, including mental health.",
                tags: ["ALBERTA", "PROVINCIAL", "MENTAL HEALTH"],
                amount: "Up to $75,000",
                scope: "AB",
                type: "prov",
                deadline: "rolling",
                link: "https://www.alberta.ca/community-initiatives-program-project-based-grant.aspx",
                contact: "cip@gov.ab.ca"
            },
            {
                id: "CFEP-001",
                agency: "CALGARY FOUNDATION",
                title: "Community Grants",
                desc: "Supporting health, social services, and community development in Calgary region.",
                tags: ["ALBERTA", "CALGARY", "COMMUNITY"],
                amount: "$5k - $50k",
                scope: "AB",
                type: "corp",
                deadline: "2025-03-01",
                link: "https://calgaryfoundation.org/",
                contact: "grants@calgaryfoundation.org"
            },
            {
                id: "ECF-001",
                agency: "EDMONTON COMMUNITY FOUNDATION",
                title: "Vital Communities",
                desc: "Grants for organizations addressing mental health, poverty, and social isolation.",
                tags: ["ALBERTA", "EDMONTON", "COMMUNITY"],
                amount: "$10k - $100k",
                scope: "AB",
                type: "corp",
                deadline: "2025-02-20",
                link: "https://www.ecfoundation.org/",
                contact: "info@ecfoundation.org"
            },

            // QUEBEC SOURCES
            {
                id: "QC-001",
                agency: "QUEBEC COMMUNITY GROUPS NETWORK",
                title: "Community Action Fund",
                desc: "Supporting English-speaking community organizations in Quebec, including mental health services.",
                tags: ["QUEBEC", "COMMUNITY", "MENTAL HEALTH"],
                amount: "$5k - $25k",
                scope: "QC",
                type: "corp",
                deadline: "2025-03-31",
                link: "https://www.qcgn.ca/",
                contact: "info@qcgn.ca"
            },
            {
                id: "FMJQ-001",
                agency: "FONDATION DU MAIRE DE MONTREAL",
                title: "Health & Wellness Grants",
                desc: "Supporting health and wellness initiatives for vulnerable populations in Montreal.",
                tags: ["QUEBEC", "MONTREAL", "HEALTH"],
                amount: "$10k - $50k",
                scope: "QC",
                type: "corp",
                deadline: "2025-04-15",
                link: "https://www.fmjq.ca/",
                contact: "info@fmjq.ca"
            },

            // NOVA SCOTIA SOURCES
            {
                id: "NS-001",
                agency: "NOVA SCOTIA HEALTH AUTHORITY",
                title: "Mental Health Innovation Fund",
                desc: "Supporting innovative approaches to mental health service delivery in Nova Scotia.",
                tags: ["NOVA SCOTIA", "MENTAL HEALTH", "INNOVATION"],
                amount: "$10k - $100k",
                scope: "NS",
                type: "prov",
                deadline: "2025-05-01",
                link: "http://www.nshealth.ca/",
                contact: "mh.innovation@nshealth.ca"
            },
            {
                id: "CFNS-001",
                agency: "COMMUNITY FOUNDATION OF NOVA SCOTIA",
                title: "Community Grants Program",
                desc: "Supporting community development, health, and social services across NS.",
                tags: ["NOVA SCOTIA", "COMMUNITY", "HEALTH"],
                amount: "$5k - $30k",
                scope: "NS",
                type: "corp",
                deadline: "rolling",
                link: "https://www.cfns-fcne.ca/",
                contact: "info@cfns-fcne.ca"
            },

            // ADDITIONAL NATIONAL SOURCES
            {
                id: "CP-006",
                agency: "CANADA POST FOUNDATION",
                title: "Community Foundation Grant",
                desc: "Funding for programs supporting children and youth (up to age 21). Ideal for 'Warrior Kids' style programming.",
                tags: ["YOUTH", "FAMILIES", "NATIONAL"],
                amount: "Up to $25,000",
                scope: "ALL",
                type: "corp",
                deadline: "rolling",
                link: "https://www.canadapost-postescanada.ca/cpc/en/our-company/community-foundation.page",
                contact: "foundation@canadapost.ca"
            },
            {
                id: "MANULIFE-001",
                agency: "MANULIFE FINANCIAL",
                title: "Community Grants",
                desc: "Supporting health, education, and community programs across Canada.",
                tags: ["CORPORATE", "HEALTH", "NATIONAL"],
                amount: "$5k - $50k",
                scope: "ALL",
                type: "corp",
                deadline: "2025-06-15",
                link: "https://www.manulife.ca/",
                contact: "community@manulife.com"
            },
            {
                id: "HOMEDEPOT-001",
                agency: "HOME DEPOT CANADA FOUNDATION",
                title: "Community Impact Grants",
                desc: "Supporting veteran causes, affordable housing, and community infrastructure.",
                tags: ["VETERANS", "HOUSING", "CORPORATE"],
                amount: "$5k - $100k",
                scope: "ALL",
                type: "corp",
                deadline: "rolling",
                link: "https://corporate.homedepot.ca/",
                contact: "foundation@homedepot.ca"
            },
            {
                id: "WALMART-001",
                agency: "WALMART CANADA",
                title: "Community Grants Program",
                desc: "Supporting hunger relief, sustainability, and community health programs.",
                tags: ["CORPORATE", "HEALTH", "COMMUNITY"],
                amount: "$1k - $25k",
                scope: "ALL",
                type: "corp",
                deadline: "rolling",
                link: "https://www.walmartcanada.ca/",
                contact: "community@walmart.ca"
            },
            {
                id: "COSTCO-001",
                agency: "COSTCO WHOLESALE CANADA",
                title: "Community Grant Program",
                desc: "Supporting children's health, education, and family services.",
                tags: ["CORPORATE", "FAMILIES", "HEALTH"],
                amount: "$1k - $10k",
                scope: "ALL",
                type: "corp",
                deadline: "rolling",
                link: "https://www.costco.ca/",
                contact: "grants@costco.ca"
            },
            {
                id: "INTACT-001",
                agency: "INTACT FOUNDATION",
                title: "Safe Communities Program",
                desc: "Grants for disaster resilience and community safety, including mental health first aid.",
                tags: ["SAFETY", "MENTAL HEALTH", "CORPORATE"],
                amount: "$10k - $100k",
                scope: "ALL",
                type: "corp",
                deadline: "2025-03-30",
                link: "https://www.intactfc.com/",
                contact: "foundation@intact.net"
            },

            // MENTAL HEALTH SPECIFIC
            {
                id: "CAMH-001",
                agency: "CAMH FOUNDATION",
                title: "Discovery Fund",
                desc: "Research grants for mental health and addiction treatment innovations.",
                tags: ["RESEARCH", "MENTAL HEALTH", "ONTARIO"],
                amount: "$25k - $250k",
                scope: "ON",
                type: "corp",
                deadline: "2025-04-01",
                link: "https://www.camh.ca/",
                contact: "foundation@camh.ca"
            },
            {
                id: "MHCC-001",
                agency: "MENTAL HEALTH COMMISSION OF CANADA",
                title: "Innovation Fund",
                desc: "Supporting innovative mental health programs and suicide prevention initiatives.",
                tags: ["MENTAL HEALTH", "INNOVATION", "FEDERAL"],
                amount: "$50k - $200k",
                scope: "FED",
                type: "fed",
                deadline: "2025-05-15",
                link: "https://www.mentalhealthcommission.ca/",
                contact: "grants@mentalhealthcommission.ca"
            },
            {
                id: "JACK-001",
                agency: "JACK.ORG",
                title: "Youth Mental Health Grants",
                desc: "Supporting youth-led mental health initiatives and peer support programs.",
                tags: ["YOUTH", "MENTAL HEALTH", "PEER SUPPORT"],
                amount: "$5k - $25k",
                scope: "ALL",
                type: "corp",
                deadline: "rolling",
                link: "https://jack.org/",
                contact: "grants@jack.org"
            },
            {
                id: "KHP-001",
                agency: "KIDS HELP PHONE",
                title: "Community Partnership Fund",
                desc: "Supporting organizations providing mental health support to young people.",
                tags: ["YOUTH", "MENTAL HEALTH", "CRISIS"],
                amount: "$10k - $50k",
                scope: "ALL",
                type: "corp",
                deadline: "2025-03-15",
                link: "https://kidshelpphone.ca/",
                contact: "partnerships@kidshelpphone.ca"
            },

            // ADDITIONAL FOUNDATION SOURCES
            {
                id: "MASTERCARD-001",
                agency: "MASTERCARD FOUNDATION",
                title: "Young People & Livelihoods",
                desc: "Large-scale funding for programs supporting youth employment and mental wellness.",
                tags: ["YOUTH", "EMPLOYMENT", "LARGE GRANT"],
                amount: "$500k - $5M",
                scope: "ALL",
                type: "corp",
                deadline: "2025-06-30",
                link: "https://mastercardfdn.org/",
                contact: "info@mastercardfdn.org"
            },
            {
                id: "METCALF-001",
                agency: "METCALF FOUNDATION",
                title: "Inclusive Local Economies",
                desc: "Supporting community economic development and social innovation.",
                tags: ["ONTARIO", "INNOVATION", "ECONOMIC"],
                amount: "$25k - $150k",
                scope: "ON",
                type: "corp",
                deadline: "2025-04-30",
                link: "https://metcalffoundation.com/",
                contact: "grants@metcalffoundation.com"
            },
            {
                id: "MCCONNELL-001",
                agency: "J.W. MCCONNELL FAMILY FOUNDATION",
                title: "Reconciliation & Social Innovation",
                desc: "Supporting reconciliation, climate, and resilient communities initiatives.",
                tags: ["INNOVATION", "RECONCILIATION", "LARGE GRANT"],
                amount: "$100k - $1M",
                scope: "ALL",
                type: "corp",
                deadline: "rolling",
                link: "https://mcconnellfoundation.ca/",
                contact: "info@mcconnellfoundation.ca"
            },
            {
                id: "HELMETS-001",
                agency: "HELMETS TO HARDHATS CANADA",
                title: "Veteran Training & Transition Support",
                desc: "Funding for programs that help veterans transition to skilled trades careers. Supports training, mentorship, and employment programs.",
                tags: ["VETERANS", "EMPLOYMENT", "TRANSITION", "TRAINING"],
                amount: "$10k - $100k",
                scope: "ALL",
                type: "corp",
                deadline: "rolling",
                link: "https://helmetstohardhats.ca/",
                contact: "info@helmetstohardhats.ca"
            },
            {
                id: "INVICTUS-001",
                agency: "INVICTUS GAMES FOUNDATION CANADA",
                title: "Adaptive Sports & Recovery Programs",
                desc: "Supporting adaptive sports programs and recovery through sport initiatives for wounded, ill, and injured veterans.",
                tags: ["VETERANS", "SPORTS", "RECOVERY", "PTSD"],
                amount: "$5k - $50k",
                scope: "ALL",
                type: "corp",
                deadline: "2025-06-30",
                link: "https://invictusgames2025.ca/",
                contact: "info@invictusgames2025.ca"
            },
            {
                id: "VAC-009",
                agency: "VETERANS AFFAIRS CANADA",
                title: "Veterans Organizations Program",
                desc: "Annual operational funding for veteran-serving organizations. Supports core operations, programs, and services for veterans and their families.",
                tags: ["VETERANS", "OPERATIONAL", "FEDERAL", "ANNUAL"],
                amount: "$25k - $200k",
                scope: "FED",
                type: "fed",
                deadline: "2025-05-31",
                link: "https://www.veterans.gc.ca/en/",
                contact: "vac.info@veterans.gc.ca"
            },
            {
                id: "CANUCK-001",
                agency: "CANUCK PLACE CHILDREN'S HOSPICE",
                title: "Military Families Support Fund",
                desc: "Grants for programs supporting children in military families dealing with trauma, loss, or serious illness. Focus on mental health and respite care.",
                tags: ["MILITARY FAMILIES", "CHILDREN", "BC", "MENTAL HEALTH"],
                amount: "$10k - $75k",
                scope: "BC",
                type: "corp",
                deadline: "rolling",
                link: "https://www.canuckplace.org/",
                contact: "foundation@canuckplace.org"
            },
            {
                id: "TREBLE-001",
                agency: "TREBLE VICTOR GROUP",
                title: "Veteran Emergency Support Fund",
                desc: "Emergency financial assistance and program grants for veterans in crisis. Supports housing, mental health interventions, and emergency needs.",
                tags: ["VETERANS", "EMERGENCY", "HOUSING", "CRISIS"],
                amount: "$1k - $25k",
                scope: "ALL",
                type: "corp",
                deadline: "rolling",
                link: "https://treblevictorgroup.org/",
                contact: "support@treblevictorgroup.org"
            },
            {
                id: "OPSEU-001",
                agency: "OPSEU FOUNDATION",
                title: "Community Services & Mental Health",
                desc: "Funding for community-based mental health programs, addiction services, and crisis intervention in Ontario. Supports veteran-focused initiatives.",
                tags: ["ONTARIO", "MENTAL HEALTH", "COMMUNITY", "UNION"],
                amount: "$5k - $30k",
                scope: "ON",
                type: "corp",
                deadline: "2025-04-30",
                link: "https://opseufoundation.org/",
                contact: "foundation@opseu.org"
            },
            {
                id: "SOLDIER-001",
                agency: "SOLDIER ON PROGRAM",
                title: "Adaptive Recreation & Sports Grants",
                desc: "CAF program supporting adaptive physical activities and sports for ill and injured CAF members and veterans. Partners with community organizations.",
                tags: ["VETERANS", "SPORTS", "FEDERAL", "ADAPTIVE"],
                amount: "$5k - $50k",
                scope: "FED",
                type: "fed",
                deadline: "rolling",
                link: "https://www.canada.ca/en/department-national-defence/services/guide/programs-canadian-armed-forces-members/soldier-on.html",
                contact: "soldieron@forces.gc.ca"
            },
            {
                id: "RONA-001",
                agency: "RONA FOUNDATION",
                title: "Community Infrastructure for Veterans",
                desc: "Grants for building renovations and infrastructure improvements at veteran-serving facilities. Supports accessible design and mental health spaces.",
                tags: ["INFRASTRUCTURE", "VETERANS", "FACILITIES"],
                amount: "$10k - $100k",
                scope: "ALL",
                type: "corp",
                deadline: "2025-03-31",
                link: "https://www.rona.ca/en/foundation",
                contact: "fondation@rona.ca"
            },
            {
                id: "MAPLE-001",
                agency: "MAPLE LEAF SPORTS & ENTERTAINMENT FOUNDATION",
                title: "Community Sport & Youth Development",
                desc: "Supporting sports-based youth programs including those serving military families and at-risk youth. Focus on mental wellness through sport.",
                tags: ["ONTARIO", "YOUTH", "SPORTS", "MENTAL HEALTH"],
                amount: "$25k - $150k",
                scope: "ON",
                type: "corp",
                deadline: "2025-05-15",
                link: "https://mlsef.ca/",
                contact: "foundation@mlse.com"
            },
            {
                id: "BGIS-001",
                agency: "BGIS GIVING PROGRAM",
                title: "Veterans Housing & Infrastructure",
                desc: "Corporate giving focused on veteran housing, facility improvements, and community infrastructure supporting military families.",
                tags: ["VETERANS", "HOUSING", "INFRASTRUCTURE"],
                amount: "$5k - $50k",
                scope: "ALL",
                type: "corp",
                deadline: "rolling",
                link: "https://www.bgis.com/",
                contact: "giving@bgis.com"
            }
        ];

        // ============================================
        // NLP ENGINE: TF-IDF RELEVANCE SCORING
        // ============================================

        // Stop words list (50+)
        const STOP_WORDS = new Set([
            'a','an','the','and','or','but','in','on','at','to','for','of','with','by',
            'from','is','it','its','this','that','are','was','were','be','been','being',
            'have','has','had','do','does','did','will','would','could','should','may',
            'might','shall','can','need','must','not','no','nor','so','if','then','than',
            'too','very','just','about','above','after','again','all','also','am','any',
            'because','before','between','both','each','few','further','get','got','here',
            'how','into','more','most','other','our','out','over','own','same','some',
            'such','through','under','until','up','us','we','what','when','where','which',
            'while','who','whom','why','you','your','these','those','there','they','them'
        ]);

        // Minimal Porter Stemmer
        function porterStem(word) {
            if (word.length < 3) return word;
            // Step: strip common suffixes longest-first
            const suffixes = [
                ['ational','ate'],['tional','tion'],['iveness','ive'],['fulness','ful'],
                ['ousness','ous'],['ization','ize'],['ational','ate'],['ation','ate'],
                ['ement',''],['ment',''],['ness',''],['tion','t'],['ible',''],
                ['able',''],['ful',''],['ous',''],['ive',''],['ize',''],
                ['ing',''],['ely',''],['ally','al'],['ling','l'],
                ['edly',''],['ting','t'],['ly',''],['ed',''],['er',''],
                ['es',''],['al',''],['s','']
            ];
            for (const [suffix, replacement] of suffixes) {
                if (word.endsWith(suffix) && (word.length - suffix.length + replacement.length) >= 2) {
                    return word.slice(0, -suffix.length) + replacement;
                }
            }
            return word;
        }

        // Tokenize text: lowercase, strip punctuation, remove stop words, stem
        function tokenize(text) {
            if (!text) return [];
            return text
                .toLowerCase()
                .replace(/[^a-z0-9\s]/g, ' ')
                .split(/\s+/)
                .filter(w => w.length > 1 && !STOP_WORDS.has(w))
                .map(w => porterStem(w));
        }

        // Build term frequency map for a token list
        function termFrequency(tokens) {
            const tf = {};
            const len = tokens.length || 1;
            for (const t of tokens) {
                tf[t] = (tf[t] || 0) + 1;
            }
            for (const t in tf) {
                tf[t] = tf[t] / len;
            }
            return tf;
        }

        // Build IDF from array of TF maps
        function inverseDocFrequency(tfMaps) {
            const docCount = tfMaps.length;
            const df = {};
            for (const tf of tfMaps) {
                for (const term in tf) {
                    df[term] = (df[term] || 0) + 1;
                }
            }
            const idf = {};
            for (const term in df) {
                idf[term] = Math.log(docCount / df[term]);
            }
            return idf;
        }

        // Build TF-IDF vector from TF map and IDF map
        function tfidfVector(tf, idf) {
            const vec = {};
            for (const term in tf) {
                if (idf[term] !== undefined) {
                    vec[term] = tf[term] * idf[term];
                }
            }
            return vec;
        }

        // Cosine similarity between two vectors (objects)
        function cosineSimilarity(vecA, vecB) {
            let dot = 0, magA = 0, magB = 0;
            for (const t in vecA) {
                magA += vecA[t] * vecA[t];
                if (vecB[t]) dot += vecA[t] * vecB[t];
            }
            for (const t in vecB) {
                magB += vecB[t] * vecB[t];
            }
            magA = Math.sqrt(magA);
            magB = Math.sqrt(magB);
            if (magA === 0 || magB === 0) return 0;
            return dot / (magA * magB);
        }

        // Jaccard similarity between two sets
        function jaccardSimilarity(setA, setB) {
            if (setA.size === 0 && setB.size === 0) return 0;
            let intersection = 0;
            for (const item of setA) {
                if (setB.has(item)) intersection++;
            }
            const union = setA.size + setB.size - intersection;
            return union === 0 ? 0 : intersection / union;
        }

        // Parse grant amount string to max numeric value
        function parseGrantMaxAmount(amountStr) {
            const cleaned = amountStr.replace(/[,$]/g, '').toUpperCase();
            const numbers = cleaned.match(/[\d]+[KMB]?/g);
            if (!numbers) return 0;
            let max = 0;
            for (const n of numbers) {
                let val = parseFloat(n);
                if (n.endsWith('K')) val *= 1000;
                else if (n.endsWith('M')) val *= 1000000;
                else if (n.endsWith('B')) val *= 1000000000;
                if (val > max) max = val;
            }
            return max;
        }

        // Map grant scope to province codes
        function grantScopeToProvinces(scope) {
            if (scope === 'ALL' || scope === 'FED') return 'NATIONAL';
            return scope;
        }

        // Compute budget fit score
        function budgetFitScore(grantAmountStr, orgBudget) {
            if (!orgBudget) return 0.5; // neutral if no budget set
            const grantMax = parseGrantMaxAmount(grantAmountStr);
            if (grantMax === 0) return 0.5; // "Variable" amounts
            const ratio = grantMax / orgBudget;
            if (ratio <= 2.0) return 1.0;
            if (ratio <= 5.0) return 0.5;
            return 0.0;
        }

        // Compute geographic match score
        function geoMatchScore(grantScope, orgProvinces) {
            if (!orgProvinces || orgProvinces.length === 0) return 0.5;
            const gs = grantScopeToProvinces(grantScope);
            if (gs === 'NATIONAL') return 0.5;
            return orgProvinces.includes(gs) ? 1.0 : 0.0;
        }

        // Main scoring pipeline: returns { grantId: score (0-100) }
        let grantRelevanceScores = {};
        let relevanceMinFilter = 0;

        function computeRelevanceScores() {
            const profile = JSON.parse(localStorage.getItem('orgProfile') || 'null');
            if (!profile || !profile.mission) {
                grantRelevanceScores = {};
                return;
            }

            // Build org profile text
            const orgText = [
                profile.mission,
                (profile.programAreas || []).join(' '),
                profile.orgType || ''
            ].join(' ');
            const orgTokens = tokenize(orgText);
            const orgTF = termFrequency(orgTokens);

            // Build TF for each grant
            const grantTFs = GRANT_DB.map(g => {
                const grantText = [g.title, g.desc, g.tags.join(' '), g.agency].join(' ');
                return termFrequency(tokenize(grantText));
            });

            // Build IDF across all grants + org profile
            const allTFs = [...grantTFs, orgTF];
            const idf = inverseDocFrequency(allTFs);

            // Build org TF-IDF vector
            const orgVec = tfidfVector(orgTF, idf);

            // Org program areas tokenized to individual words for matching
            const orgAreaWords = new Set();
            (profile.programAreas || []).forEach(a => {
                a.toLowerCase().split(/\s+/).forEach(w => { if (w.length > 2) orgAreaWords.add(w); });
            });

            const orgBudget = parseFloat(profile.budget) || 0;
            const orgProvinces = profile.provinces || [];

            // Score each grant â€” first pass: raw component scores
            const rawScores = [];
            GRANT_DB.forEach((grant, i) => {
                const grantVec = tfidfVector(grantTFs[i], idf);
                const textScore = cosineSimilarity(orgVec, grantVec);
                const grantTagWords = new Set();
                grant.tags.forEach(t => {
                    t.toLowerCase().split(/\s+/).forEach(w => { if (w.length > 2) grantTagWords.add(w); });
                });
                const tagScore = jaccardSimilarity(orgAreaWords, grantTagWords);
                const budgetScore = budgetFitScore(grant.amount, orgBudget);
                const geoScore = geoMatchScore(grant.scope, orgProvinces);
                rawScores.push({ id: grant.id, textScore, tagScore, budgetScore, geoScore });
            });

            // Second pass: raw composite scores
            const composites = rawScores.map(r => {
                return (r.textScore * 0.50) + (r.tagScore * 0.20) + (r.budgetScore * 0.15) + (r.geoScore * 0.15);
            });

            // Min-max normalize the final composite scores to use the full 0-100 range
            const compMin = Math.min(...composites);
            const compRange = (Math.max(...composites) - compMin) || 1;

            grantRelevanceScores = {};
            rawScores.forEach((r, i) => {
                const normalized = (composites[i] - compMin) / compRange;
                // Power curve (sqrt) stretches mid-range scores upward for readable distribution
                const curved = Math.pow(normalized, 0.55);
                grantRelevanceScores[r.id] = Math.min(100, Math.round(curved * 100));
            });

            // Update AI summary UI
            updateAISummary();
        }

        function updateAISummary() {
            const summaryEl = document.getElementById('aiSummary');
            const profile = JSON.parse(localStorage.getItem('orgProfile') || 'null');
            if (!profile || !profile.mission) {
                summaryEl.classList.add('hidden');
                return;
            }
            summaryEl.classList.remove('hidden');

            const scores = Object.values(grantRelevanceScores);
            const scored = scores.length;
            const avg = scored > 0 ? Math.round(scores.reduce((a,b) => a+b, 0) / scored) : 0;
            const highConf = scores.filter(s => s > 80).length;

            document.getElementById('aiScored').innerText = scored;
            document.getElementById('aiAvgScore').innerText = avg + '%';
            document.getElementById('aiHighConf').innerText = highConf;
        }

        function getRelevanceScore(grantId) {
            return grantRelevanceScores[grantId] !== undefined ? grantRelevanceScores[grantId] : null;
        }

        function hasOrgProfile() {
            const profile = JSON.parse(localStorage.getItem('orgProfile') || 'null');
            return !!(profile && profile.mission && profile.mission.trim().length > 0);
        }

        // ============================================
        // STATE MANAGEMENT & LOCAL STORAGE
        // ============================================
        let currentView = 'discover';
        let trackedGrants = JSON.parse(localStorage.getItem('trackedGrants') || '{}');
        let grantNotes = JSON.parse(localStorage.getItem('grantNotes') || '{}');
        let activeFilters = { status: 'all' };

        const logArea = document.getElementById('console');
        const grid = document.getElementById('grid');
        const matchCount = document.getElementById('matchCount');
        const dbCount = document.getElementById('dbCount');
        const trackedStat = document.getElementById('trackedStat');
        const trackedCount = document.getElementById('trackedCount');
        const viewTitle = document.getElementById('viewTitle');
        const emptyState = document.getElementById('emptyState');

        // Initialize
        dbCount.innerText = GRANT_DB.length;
        updateTrackedCount();

        // Log database stats
        console.log(`Grant Recon v2.1 - Database loaded: ${GRANT_DB.length} grants`);

        // Navigation
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                currentView = tab.dataset.view;

                if (currentView === 'discover') {
                    viewTitle.innerText = 'Intelligence Report';
                    runMission();
                } else {
                    viewTitle.innerText = 'Tracked Grants';
                    showTrackedGrants();
                }
            });
        });

        // Status Filter Chips
        document.querySelectorAll('#statusFilters .chip').forEach(chip => {
            chip.addEventListener('click', () => {
                document.querySelectorAll('#statusFilters .chip').forEach(c => c.classList.remove('active'));
                chip.classList.add('active');
                activeFilters.status = chip.dataset.status;

                if (currentView === 'discover') {
                    runMission();
                } else {
                    showTrackedGrants();
                }
            });
        });

        // ============================================
        // LOGGING SYSTEM
        // ============================================
        function log(msg, type="text") {
            const div = document.createElement('div');
            div.className = 'log-entry';
            const time = new Date().toLocaleTimeString([], {hour12:false, hour: '2-digit', minute:'2-digit', second:'2-digit'});

            let colorClass = "log-text";
            if(type === "success") colorClass = "log-success";
            if(type === "warn") colorClass = "log-warn";
            if(type === "error") colorClass = "log-error";

            div.innerHTML = `<span class="log-time">[${time}]</span><span class="${colorClass}">${msg}</span>`;
            logArea.appendChild(div);
            logArea.scrollTop = logArea.scrollHeight;
        }

        // ============================================
        // MISSION SCAN
        // ============================================
        function runMission() {
            grid.innerHTML = '';
            emptyState.classList.add('hidden');
            matchCount.innerText = '0';

            const keywords = document.getElementById('keywords').value.toUpperCase().split(',').map(k => k.trim());
            const scope = document.getElementById('scope').value;

            log("Initiating scan sequence...", "text");

            setTimeout(() => {
                log(`Scanning database for: ${keywords.join(', ')}`, "text");

                setTimeout(() => {
                    performSearch(keywords, scope);
                }, 400);
            }, 300);
        }

        function performSearch(keywords, scope) {
            let results = GRANT_DB.filter(grant => {
                // Scope Check
                const scopeMatch = (scope === 'ALL') || (grant.scope === 'FED') || (grant.scope === scope) || (grant.scope === 'ALL');
                if(!scopeMatch) return false;

                // Keyword Check
                const text = (grant.title + " " + grant.desc + " " + grant.tags.join(" ")).toUpperCase();
                const keywordMatch = keywords.some(k => text.includes(k));
                return keywordMatch;
            });

            // Apply relevance min filter if profile exists
            if (hasOrgProfile() && relevanceMinFilter > 0) {
                results = results.filter(g => (getRelevanceScore(g.id) || 0) >= relevanceMinFilter);
            }

            // Sort by relevance if profile exists
            if (hasOrgProfile()) {
                results.sort((a, b) => (getRelevanceScore(b.id) || 0) - (getRelevanceScore(a.id) || 0));
            }

            log(`Scan complete. Found ${results.length} matching grants.`, "success");

            // Log AI scoring info
            if (hasOrgProfile()) {
                const scored = Object.keys(grantRelevanceScores).length;
                log(`[AI] Computed relevance scores for ${scored} grants against org profile`, "success");
                if (results.length > 0) {
                    const topGrant = results[0];
                    const topScore = getRelevanceScore(topGrant.id) || 0;
                    log(`[AI] Top match: ${topGrant.title} (${topScore}% relevance)`, "success");
                }
                const highConf = Object.values(grantRelevanceScores).filter(s => s > 80).length;
                log(`[AI] ${highConf} grants scored above 80% confidence threshold`, "success");
            }

            matchCount.innerText = results.length;
            renderGrants(results);
        }

        // ============================================
        // SHOW TRACKED GRANTS
        // ============================================
        function showTrackedGrants() {
            grid.innerHTML = '';

            const tracked = GRANT_DB.filter(g => trackedGrants[g.id]);

            // Apply status filter
            let filtered = tracked;
            if (activeFilters.status !== 'all') {
                filtered = tracked.filter(g => trackedGrants[g.id].status === activeFilters.status);
            }

            // Sort by relevance if profile exists
            if (hasOrgProfile()) {
                filtered.sort((a, b) => (getRelevanceScore(b.id) || 0) - (getRelevanceScore(a.id) || 0));
            }

            if (filtered.length === 0) {
                emptyState.classList.remove('hidden');
                matchCount.innerText = '0';
            } else {
                emptyState.classList.add('hidden');
                matchCount.innerText = filtered.length;
                renderGrants(filtered);
            }
        }

        // ============================================
        // RENDER GRANT CARDS
        // ============================================
        function renderGrants(grants) {
            grid.innerHTML = '';

            grants.forEach(grant => {
                const card = document.createElement('div');
                card.className = 'card';

                const isTracked = trackedGrants[grant.id];
                const status = isTracked ? trackedGrants[grant.id].status : 'discovered';
                const notes = grantNotes[grant.id] || '';

                // Deadline calculation
                const deadlineHTML = getDeadlineHTML(grant.deadline);

                // Type badge
                const typeBadge = grant.type === 'fed' ? 'badge-fed' :
                                 grant.type === 'prov' ? 'badge-prov' : 'badge-corp';

                // Relevance badge
                const score = getRelevanceScore(grant.id);
                let relevanceBadgeHTML = '';
                if (score !== null) {
                    let relClass = 'relevance-low';
                    if (score > 80) relClass = 'relevance-high';
                    else if (score >= 50) relClass = 'relevance-mid';
                    relevanceBadgeHTML = `<span class="relevance-badge ${relClass}">MATCH: ${score}%</span>`;
                }

                // Recommended badge: show on tracked view for untracked grants >85%
                let recommendedHTML = '';
                if (currentView === 'tracked' && !isTracked && score !== null && score > 85) {
                    recommendedHTML = '<span class="badge-recommended">RECOMMENDED</span>';
                }
                // Also show recommended in discover view for untracked grants >85%
                if (currentView === 'discover' && !isTracked && score !== null && score > 85) {
                    recommendedHTML = '<span class="badge-recommended">RECOMMENDED</span>';
                }

                card.innerHTML = `
                    <div class="card-header">
                        <div class="card-badges">
                            <span class="card-badge ${typeBadge}">${grant.scope}</span>
                            ${deadlineHTML}
                            ${relevanceBadgeHTML}
                            ${recommendedHTML}
                        </div>
                    </div>

                    <div class="card-agency">${grant.agency}</div>
                    <div class="card-title">${grant.title}</div>
                    <div class="card-desc">${grant.desc}</div>

                    <div class="card-tags">
                        ${grant.tags.map(t => `<span class="tag">${t}</span>`).join('')}
                    </div>

                    ${isTracked ? `
                        <div class="status-selector">
                            <div class="status-label">Application Status</div>
                            <div class="status-options">
                                <div class="status-option status-discovered ${status === 'discovered' ? 'active' : ''}" onclick="updateStatus('${grant.id}', 'discovered')">Discovered</div>
                                <div class="status-option status-researching ${status === 'researching' ? 'active' : ''}" onclick="updateStatus('${grant.id}', 'researching')">Researching</div>
                                <div class="status-option status-preparing ${status === 'preparing' ? 'active' : ''}" onclick="updateStatus('${grant.id}', 'preparing')">Preparing</div>
                                <div class="status-option status-submitted ${status === 'submitted' ? 'active' : ''}" onclick="updateStatus('${grant.id}', 'submitted')">Submitted</div>
                                <div class="status-option status-approved ${status === 'approved' ? 'active' : ''}" onclick="updateStatus('${grant.id}', 'approved')">Approved</div>
                                <div class="status-option status-rejected ${status === 'rejected' ? 'active' : ''}" onclick="updateStatus('${grant.id}', 'rejected')">Rejected</div>
                            </div>
                        </div>

                        <div class="card-notes">
                            <textarea class="notes-textarea" placeholder="Add notes, requirements, contacts..."
                                oninput="saveNote('${grant.id}', this.value)">${notes}</textarea>
                        </div>
                    ` : ''}

                    <div class="card-footer">
                        <div class="amount">${grant.amount}</div>
                        <div class="card-actions">
                            <button class="btn-action btn-track ${isTracked ? 'tracked' : ''}"
                                onclick="toggleTrack('${grant.id}')">
                                ${isTracked ? 'âœ“ TRACKED' : '+ TRACK'}
                            </button>
                            <button class="btn-action" onclick="window.open('${grant.link}', '_blank')">
                                VIEW
                            </button>
                        </div>
                    </div>
                `;

                grid.appendChild(card);
            });
        }

        // ============================================
        // DEADLINE CALCULATION
        // ============================================
        function getDeadlineHTML(deadline) {
            if (deadline === 'rolling') {
                return '<div class="deadline-indicator deadline-rolling">âŠš ROLLING</div>';
            }

            const deadlineDate = new Date(deadline);
            const today = new Date();
            const daysUntil = Math.ceil((deadlineDate - today) / (1000 * 60 * 60 * 24));

            if (daysUntil < 0) {
                return '<div class="deadline-indicator deadline-urgent">âš  CLOSED</div>';
            } else if (daysUntil <= 7) {
                return `<div class="deadline-indicator deadline-urgent">âš¡ ${daysUntil}d</div>`;
            } else if (daysUntil <= 30) {
                return `<div class="deadline-indicator deadline-soon">â—† ${daysUntil}d</div>`;
            } else {
                return `<div class="deadline-indicator deadline-ok">â—‡ ${daysUntil}d</div>`;
            }
        }

        // ============================================
        // TRACKING FUNCTIONS
        // ============================================
        function toggleTrack(grantId) {
            if (trackedGrants[grantId]) {
                delete trackedGrants[grantId];
                log(`Removed grant ${grantId} from tracking.`, "warn");
            } else {
                trackedGrants[grantId] = { status: 'discovered', trackedAt: new Date().toISOString() };
                log(`Added grant ${grantId} to tracking.`, "success");
            }

            localStorage.setItem('trackedGrants', JSON.stringify(trackedGrants));
            updateTrackedCount();

            // Re-render current view
            if (currentView === 'discover') {
                runMission();
            } else {
                showTrackedGrants();
            }
        }

        function updateStatus(grantId, status) {
            if (trackedGrants[grantId]) {
                trackedGrants[grantId].status = status;
                localStorage.setItem('trackedGrants', JSON.stringify(trackedGrants));
                log(`Updated grant ${grantId} status to: ${status}`, "success");

                // Re-render
                if (currentView === 'tracked') {
                    showTrackedGrants();
                }
            }
        }

        function saveNote(grantId, note) {
            grantNotes[grantId] = note;
            localStorage.setItem('grantNotes', JSON.stringify(grantNotes));
        }

        function updateTrackedCount() {
            const count = Object.keys(trackedGrants).length;
            trackedStat.innerText = count;
            trackedCount.innerText = count;
        }

        // ============================================
        // EXPORT FUNCTIONS
        // ============================================
        function exportData() {
            document.getElementById('exportModal').classList.remove('hidden');
        }

        function closeExportModal() {
            document.getElementById('exportModal').classList.add('hidden');
        }

        function downloadJSON() {
            const trackedData = {};
            GRANT_DB.filter(g => trackedGrants[g.id]).forEach(grant => {
                trackedData[grant.id] = {
                    ...trackedGrants[grant.id],
                    relevanceScore: getRelevanceScore(grant.id)
                };
            });

            const data = {
                tracked: trackedData,
                notes: grantNotes,
                relevanceScores: grantRelevanceScores,
                exportedAt: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `grant-tracker-export-${new Date().toISOString().split('T')[0]}.json`;
            a.click();

            log("Exported data as JSON.", "success");
            closeExportModal();
        }

        function downloadCSV() {
            const tracked = GRANT_DB.filter(g => trackedGrants[g.id]);

            let csv = 'Agency,Title,Amount,Deadline,Status,Scope,Link,Notes,RelevanceScore\n';

            tracked.forEach(grant => {
                const status = trackedGrants[grant.id].status;
                const notes = (grantNotes[grant.id] || '').replace(/"/g, '""');
                const relScore = getRelevanceScore(grant.id);
                const relScoreStr = relScore !== null ? relScore : '';

                csv += `"${grant.agency}","${grant.title}","${grant.amount}","${grant.deadline}","${status}","${grant.scope}","${grant.link}","${notes}","${relScoreStr}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `grant-tracker-export-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();

            log("Exported data as CSV.", "success");
            closeExportModal();
        }

        function downloadCalendar() {
            const tracked = GRANT_DB.filter(g => trackedGrants[g.id] && g.deadline !== 'rolling');

            let ics = 'BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//Grant Tracker//EN\n';

            tracked.forEach(grant => {
                const deadline = new Date(grant.deadline);
                const dateStr = deadline.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';

                ics += 'BEGIN:VEVENT\n';
                ics += `UID:${grant.id}@granttracker\n`;
                ics += `DTSTAMP:${new Date().toISOString().replace(/[-:]/g, '').split('.')[0]}Z\n`;
                ics += `DTSTART:${dateStr}\n`;
                ics += `SUMMARY:Grant Deadline: ${grant.title}\n`;
                ics += `DESCRIPTION:${grant.agency} - ${grant.amount}\\n${grant.link}\n`;
                ics += `URL:${grant.link}\n`;
                ics += 'END:VEVENT\n';
            });

            ics += 'END:VCALENDAR';

            const blob = new Blob([ics], { type: 'text/calendar' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `grant-deadlines-${new Date().toISOString().split('T')[0]}.ics`;
            a.click();

            log("Exported deadlines as calendar file.", "success");
            closeExportModal();
        }

        // ============================================
        // ORGANIZATION PROFILE MANAGEMENT
        // ============================================
        function toggleProfile() {
            const body = document.getElementById('profileBody');
            const arrow = document.getElementById('profileArrow');
            body.classList.toggle('open');
            arrow.classList.toggle('open');
        }

        // Program area tag click handlers
        document.querySelectorAll('#programAreaTags .profile-tag').forEach(tag => {
            tag.addEventListener('click', () => {
                tag.classList.toggle('selected');
            });
        });

        // Relevance filter chip handlers
        document.querySelectorAll('#relevanceFilters .relevance-chip').forEach(chip => {
            chip.addEventListener('click', () => {
                document.querySelectorAll('#relevanceFilters .relevance-chip').forEach(c => c.classList.remove('active'));
                chip.classList.add('active');
                relevanceMinFilter = parseInt(chip.dataset.min) || 0;

                // Re-render current view
                if (currentView === 'discover') {
                    runMission();
                } else {
                    showTrackedGrants();
                }
            });
        });

        function saveOrgProfile() {
            const mission = document.getElementById('orgMission').value.trim();
            const orgType = document.getElementById('orgType').value;
            const budget = document.getElementById('orgBudget').value;

            // Collect selected program areas
            const programAreas = [];
            document.querySelectorAll('#programAreaTags .profile-tag.selected').forEach(tag => {
                programAreas.push(tag.dataset.area);
            });

            // Collect selected provinces
            const provinces = [];
            document.querySelectorAll('#provinceGrid input[type="checkbox"]:checked').forEach(cb => {
                provinces.push(cb.value);
            });

            const profile = {
                mission: mission,
                programAreas: programAreas,
                orgType: orgType,
                budget: budget,
                provinces: provinces,
                savedAt: new Date().toISOString()
            };

            localStorage.setItem('orgProfile', JSON.stringify(profile));
            log('[AI] Organization profile saved. Computing relevance scores...', 'success');

            // Recompute scores
            computeRelevanceScores();

            // Re-render current view
            if (currentView === 'discover') {
                runMission();
            } else {
                showTrackedGrants();
            }
        }

        function loadOrgProfile() {
            const profile = JSON.parse(localStorage.getItem('orgProfile') || 'null');
            if (!profile) return;

            // Restore mission
            if (profile.mission) {
                document.getElementById('orgMission').value = profile.mission;
            }

            // Restore org type
            if (profile.orgType) {
                document.getElementById('orgType').value = profile.orgType;
            }

            // Restore budget
            if (profile.budget) {
                document.getElementById('orgBudget').value = profile.budget;
            }

            // Restore program areas
            if (profile.programAreas) {
                document.querySelectorAll('#programAreaTags .profile-tag').forEach(tag => {
                    if (profile.programAreas.includes(tag.dataset.area)) {
                        tag.classList.add('selected');
                    }
                });
            }

            // Restore provinces
            if (profile.provinces) {
                document.querySelectorAll('#provinceGrid input[type="checkbox"]').forEach(cb => {
                    if (profile.provinces.includes(cb.value)) {
                        cb.checked = true;
                    }
                });
            }

            // Compute scores on load
            computeRelevanceScores();
        }

        // ============================================
        // AUTO-RUN ON LOAD
        // ============================================
        window.addEventListener('load', () => {
            // Load saved org profile and compute scores
            loadOrgProfile();

            setTimeout(() => {
                runMission();
            }, 500);
        });
    </script>
</body>
</html>